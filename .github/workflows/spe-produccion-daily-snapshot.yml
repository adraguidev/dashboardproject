# Workflow para Snapshot AutomÃ¡tico Diario de SPE ProducciÃ³n
name: SPE Production Daily Snapshot

# Ejecutar todos los dÃ­as a las 11 PM hora de PerÃº (4 AM UTC del dÃ­a siguiente)
on:
  schedule:
    # PerÃº = UTC-5, asÃ­ que 11 PM PerÃº = 4 AM UTC del dÃ­a siguiente
    # Formato: min hour day-of-month month day-of-week
    - cron: '0 4 * * *'
  
  # TambiÃ©n permitir ejecuciÃ³n manual para testing
  workflow_dispatch:

jobs:
  spe-produccion-snapshot:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del cÃ³digo (necesario para logs)
      - name: Check out repository code
        uses: actions/checkout@v3

      # 2. Configurar Node.js (por si necesitamos dependencias)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3. Mostrar hora actual para debugging
      - name: Show current time
        run: |
          echo "UTC Time: $(date -u)"
          echo "Peru Time (UTC-5): $(TZ='America/Lima' date)"

      # 4. Ejecutar snapshot SPE ProducciÃ³n
      - name: Take SPE Produccion Snapshot
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        run: |
          echo "ğŸ” Iniciando snapshot automÃ¡tico de SPE ProducciÃ³n..."
          
          # Hacer llamada HTTP POST al endpoint de snapshot de producciÃ³n
          response=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_API_SECRET }}" \
            -H "Content-Type: application/json" \
            -w "%{http_code}" \
            -s \
            -o response_produccion.json \
            "${{ secrets.API_URL }}/api/historico/spe-produccion-snapshot")
          
          echo "ğŸ“¡ HTTP Status Code: $response"
          
          # Mostrar respuesta
          echo "ğŸ“‹ Response body:"
          cat response_produccion.json
          
          # Verificar si fue exitoso
          if [ "$response" -eq 200 ]; then
            echo "âœ… Snapshot SPE ProducciÃ³n creado exitosamente"
            
            # Extraer informaciÃ³n de la respuesta para logs
            if command -v jq >/dev/null 2>&1; then
              success=$(jq -r '.success' response_produccion.json 2>/dev/null || echo "unknown")
              message=$(jq -r '.message // empty' response_produccion.json 2>/dev/null || echo "")
              evaluadores=$(jq -r '.results.evaluadores // empty' response_produccion.json 2>/dev/null || echo "")
              total=$(jq -r '.results.totalExpedientes // empty' response_produccion.json 2>/dev/null || echo "")
              finalizadas=$(jq -r '.results.finalizadas // empty' response_produccion.json 2>/dev/null || echo "")
              iniciadas=$(jq -r '.results.iniciadas // empty' response_produccion.json 2>/dev/null || echo "")
              
              echo "ğŸ“Š Resultado: $success"
              if [ ! -z "$message" ]; then
                echo "ğŸ’¬ Mensaje: $message"
              fi
              if [ ! -z "$evaluadores" ] && [ ! -z "$total" ]; then
                echo "ğŸ“ˆ EstadÃ­sticas: $evaluadores evaluadores, $total expedientes"
                if [ ! -z "$finalizadas" ] && [ ! -z "$iniciadas" ]; then
                  echo "ğŸ“ˆ Desglose: $finalizadas finalizadas, $iniciadas iniciadas"
                fi
              fi
            fi
          else
            echo "âŒ Error en snapshot SPE ProducciÃ³n. Status code: $response"
            cat response_produccion.json
            exit 1
          fi

      # 5. Limpiar archivos temporales
      - name: Cleanup
        if: always()
        run: |
          rm -f response_produccion.json 